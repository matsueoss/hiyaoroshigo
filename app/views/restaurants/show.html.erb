<div id="restaurant-name">
  <%= @restaurant.official_name %>
</div>
<div id="checkin-panel">
  <%= link_to "今いるお店が、上記と違う場合はこちら", new_checkin_path %>
</div>
<div id="sakes">
  <% @restaurant.sakes.each do |sake| %>
    <div class="sake">
      <%= image_tag sake.photo(:medium), alt: sake.name %>
    </div>
  <% end %>
</div>
<div id="sake-info">
  <div id="sake-name"></div>
  <div>
    <%= button_to '投票', '', id: 'vote-button', class: 'normal', method: :get, remote: true, form: { id: 'vote' } %>
  </div>
</div>
<div id="vote-modal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
</div>

<script type="text/javascript">
  var index = 0;
  var sakes = <%= raw @restaurant.sakes.map { |sake|
    if sake.voted?(current_drinker)
      text  = '投票を取り消す'
      url   = drinking_path(@drinkings.find_by(sake: sake))
      klass = 'normal cancel'
    else
      text  = '投票'
      url   = new_drinking_path(restaurant_id: @restaurant.id, sake_id: sake.id)
      klass = 'normal'
    end
    { name: sake.name, vote_text: text, vote_url: url, klass: klass }
  }.to_json %>;

  function setSakeName(name) {
    $('#sake-name').empty().append(_.escape(name).replace(/\s+/g, '<br/>'));
  }

  function setVoteText(text) {
    $('#vote-button').val(text);
  }

  function setVoteUrl(url) {
    $('#vote').attr('action', url);
  }

  function setVoteButtonClass(class_name) {
    $('#vote-button').removeClass();
    $('#vote-button').addClass(class_name);
  }

  $('#sakes').slick({
    infinite: false,
    arrows: true,
    dots: true
  });

  $('#sakes').on('afterChange', function(e, slick, currentSlide) {
    index = currentSlide;
    setSakeName(sakes[currentSlide].name);
    setVoteText(sakes[index].vote_text);
    setVoteUrl(sakes[index].vote_url);
    setVoteButtonClass(sakes[index].klass);
  });
  setSakeName(sakes[0].name);
  setVoteText(sakes[0].vote_text);
  setVoteUrl(sakes[0].vote_url);
  setVoteButtonClass(sakes[0].klass);
</script>
